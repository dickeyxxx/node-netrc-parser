---
version: 2
executorType: docker
containerInfo:
  - image: dickeyxxx/cli-engine-docker@sha256:53c49a2d164240b3e55eca24635e202ca2536dc15ea0cf6223dd8fc2e7b67be3
stages:
  build:
    workDir: ~/node-netrc-parser
    environment:
      - CIRCLE_PROJECT_USERNAME: dickeyxxx
      - CIRCLE_PROJECT_REPONAME: node-netrc-parser
    steps:
      - type: checkout
      - type: cache-restore
        key: node-netrc-parser-{{checksum "package.json"}}
      - type: shell
        command: |
          set -exu
          yarn
          gpg --import gpg.key
          ./set-trust.sh
          cat >> ~/.gnupg/gpg.conf <<EOF
            default-recipient node-netrc-parser
          EOF

          cat > ~/.netrc <<EOF
          machine foo.com
            login l
            password p
          EOF

          JEST_JUNIT_OUTPUT=/tmp/test-results/jest/junit.xml ./node_modules/.bin/jest --coverage --testResultsProcessor jest-junit
          ./node_modules/.bin/flow check
          ./node_modules/.bin/standard
          bash <(curl -s https://codecov.io/bash)
      - type: test-results-store
        path: /tmp/test-results
      - type: cache-save
        key: node-netrc-parser-{{checksum "package.json"}}
        paths:
          - /usr/local/share/.cache/yarn
          - ~/node-netrc-parser/node_modules
